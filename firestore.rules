rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isValidInbox(value) {
      return value is string && value.size() > 0 && value.size() <= 80;
    }

    match /messages/{messageId} {
      allow read: if true;

      allow create: if
        request.resource.data.keys().hasOnly([
          'inbox',
          'internalId',
          'openText',
          'encryptedText',
          'encryptedLength',
          'createdAt'
        ]) &&
        isValidInbox(request.resource.data.inbox) &&
        request.resource.data.internalId is int &&
        request.resource.data.internalId > 0 &&
        request.resource.data.openText is string &&
        request.resource.data.openText.size() <= 5000 &&
        request.resource.data.encryptedText is string &&
        request.resource.data.encryptedLength is int &&
        request.resource.data.encryptedLength >= 0 &&
        request.resource.data.encryptedLength <= 5000;

      allow update, delete: if false;
    }

    match /inboxCounters/{inboxId} {
      // Message creation uses a transaction that reads the counter first,
      // so we must allow get() on the counter document.
      allow get: if isValidInbox(inboxId);
      allow list: if false;

      allow create, update: if
        inboxId == request.resource.id &&
        isValidInbox(inboxId) &&
        request.resource.data.keys().hasOnly(['nextInternalId']) &&
        request.resource.data.nextInternalId is int &&
        request.resource.data.nextInternalId > 1 &&
        (
          !exists(/databases/$(database)/documents/inboxCounters/$(inboxId)) ||
          request.resource.data.nextInternalId == resource.data.nextInternalId + 1
        );

      allow delete: if false;
    }
  }
}
